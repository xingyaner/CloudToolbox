<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Cloud Toolbox Pro - Master Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* æ ·å¼å®Œå…¨ä¿ç•™æ¯æœ¬ */
        :root { --primary: #007AFF; --bg: #F0F2F5; --terminal-bg: #1E1E1E; --terminal-text: #00FF00; --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --trans-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 240px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
        .logo { font-size: 18px; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; background: #28a745; border-radius: 50%; box-shadow: 0 0 5px #28a745; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #666; transition: 0.2s; font-size: 14px; }
        .nav-item:hover { background: #f5f5f5; color: var(--primary); }
        .nav-item.active { background: #E3F2FD; color: var(--primary); font-weight: bold; }
        .main { flex: 1; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; }
        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        textarea, input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin: 10px 0; font-family: monospace; font-size: 14px; display: block; }
	textarea { resize: vertical; min-height: 100px; }
	input[type="text"] { height: 45px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .copy-btn { float: right; padding: 4px 10px; font-size: 11px; background: #f0f0f0; color: #555; border-radius: 4px; margin-top: -4px; cursor: pointer; }
        .res-content { padding:15px; border-radius:6px; white-space:pre-wrap; font-family: monospace; font-size: 13px; border: 1px solid #eee; overflow-x: auto; background: #f9f9f9; min-height: 20px; }
        .ai-box { border: 1px solid #764ba2; background: #fdfaff !important; display: none; margin-top: 15px; padding: 15px; border-radius: 6px; }
        .btn-ai { background: var(--ai-gradient); margin-top: 15px; width: 100%; display: none; }
        .btn-trans { background: var(--trans-gradient); margin-top: 10px; width: 100%; display: none; }
	.terminal-window { display: none; background: var(--terminal-bg); color: var(--terminal-text); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; height: 120px; overflow-y: auto; margin-top: 10px; }
        
        /* è¡¥å…… Tool 2 çš„å®¡è®¡å¸ƒå±€æ ·å¼ï¼Œä¸å½±å“åŸæœ‰æ ·å¼ */
        .audit-container { display: flex; gap: 20px; height: 400px; }
        .code-editor { flex: 1; display: flex; flex-direction: column; }
        .audit-result { flex: 1; background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 15px; overflow-y: auto; font-size: 13px; }
	.image-upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; background: #fafafa; cursor: pointer; transition: 0.3s; margin-bottom: 15px; }
        .image-upload-area:hover { border-color: var(--primary); background: #f0f7ff; }
        .risk-level { padding: 4px 12px; border-radius: 4px; font-weight: 600; display: inline-block; margin: 5px 0; }
        .risk-safe { background: #e6fffa; color: #2c7a7b; }
        .risk-high { background: #fff1f0; color: #cf1322; }
        
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px);} to { opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><div class="status-dot"></div> äº‘ä¸Šå·¥å…·ç®±</div>
        <div class="nav-item active" onclick="switchTab('dedup')">âš¡ æ–‡æœ¬æ™ºèƒ½å»é‡</div>
        <div class="nav-item" onclick="switchTab('ocr')">ğŸ‘ï¸ å›¾ç‰‡æ–‡æœ¬è¯†åˆ«</div>
        <div class="nav-item" onclick="switchTab('table')">ğŸ“Š å›¾ç‰‡è¡¨æ ¼è¯†åˆ«</div>
        <div class="nav-item" onclick="switchTab('qr')">ğŸ“² äº‘ç«¯äºŒç»´ç </div>
        <div class="nav-item" onclick="switchTab('pwd')">ğŸ”‘ å®‰å…¨å¯†ç ç”Ÿæˆ</div>
        <div class="nav-item" onclick="switchTab('phy')">âš›ï¸ ç‰©ç†ä»¿çœŸæ¨¡æ‹Ÿ</div>
        <div class="nav-item" onclick="switchTab('audit')">ğŸ§  AI ä»£ç å®¡è®¡</div>
        <div class="nav-item" onclick="switchTab('base64')">ğŸ”£ Base64 è½¬æ¢</div>
        <div class="nav-item" onclick="switchTab('ua')">ğŸ“² è®¾å¤‡åˆ†æ</div>
        <div class="nav-item" onclick="switchTab('site')">ğŸ’“ ç½‘ç«™å¿ƒè·³</div>
        <div class="nav-item" onclick="switchTab('burn')">ğŸ”¥ é˜…åå³ç„š</div>
	<div class="nav-item" onclick="switchTab('safeimg')">ğŸ›¡ï¸ å›¾ç‰‡å®‰å…¨è¯†åˆ«</div>
    </div>



    <div class="main">
        <!-- 1. æ–‡æœ¬å»é‡ -->
        <div id="panel-dedup" class="panel active"><div class="card">
            <h2>â˜ï¸ æ–‡æœ¬å»é‡ (Deduplication)</h2>
            <textarea id="inp-dedup" rows="6" placeholder="è¾“å…¥é‡å¤åˆ—è¡¨..."></textarea>
            <button onclick="runTask('dedup')">æ‰§è¡Œäº‘ç«¯è®¡ç®—</button>
        </div></div>

        <!-- 2. å›¾ç‰‡æ–‡æœ¬è¯†åˆ« -->
        <div id="panel-ocr" class="panel"><div class="card">
            <h2>â˜ï¸ å›¾ç‰‡æ–‡æœ¬è¯†åˆ«</h2>
            <p style="color: #666; font-size: 13px;">æç¤ºï¼šæ”¯æŒç‚¹å‡»ä¸Šä¼ æˆ–ç›´æ¥ Ctrl + V ç²˜è´´æˆªå›¾</p>
            <input type="file" id="inp-ocr-file" accept="image/*" onchange="handleFileInput(this, 'img-preview')">
            <div style="text-align: center;"><img id="img-preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border-radius: 4px;"></div>
            <button onclick="runTask('ocr')" style="margin-top:10px">å¼€å§‹è¯†åˆ«æ–‡å­—</button>
        </div></div>

        <!-- 3. å›¾ç‰‡è¡¨æ ¼è¯†åˆ« -->
        <div id="panel-table" class="panel"><div class="card">
            <h2>ğŸ“Š å›¾ç‰‡è¡¨æ ¼æ–‡æœ¬è¯†åˆ«</h2>
            <p style="color: #666; font-size: 13px;">è¯†åˆ«å›¾ç‰‡ä¸­çš„è¡¨æ ¼å¹¶è¿˜åŸè¡Œåˆ—ç»“æ„ï¼ˆMarkdown/çº¯æ–‡æœ¬åŒç‰ˆæœ¬ï¼‰ã€‚<br>æç¤ºï¼šæ”¯æŒç‚¹å‡»ä¸Šä¼ æˆ–ç›´æ¥ Ctrl + V ç²˜è´´è¡¨æ ¼æˆªå›¾</p>
            <input type="file" id="inp-table-file" accept="image/*" onchange="handleFileInput(this, 'img-table-preview')">
            <div style="text-align: center;"><img id="img-table-preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border-radius: 4px;"></div>
            <button onclick="runTask('table_ocr')" style="margin-top:10px">å¼€å§‹æå–è¡¨æ ¼</button>
        </div></div>

        <!-- 4. äº‘ç«¯äºŒç»´ç  -->
        <div id="panel-qr" class="panel"><div class="card">
            <h2>â˜ï¸ çŸ¢é‡äºŒç»´ç  (Cloud QR Gen)</h2>
            <input type="text" id="inp-qr" placeholder="è¾“å…¥ç½‘å€æˆ–æ–‡å­—...">
            <button onclick="runTask('qr')">å¼€å§‹æ¸²æŸ“</button>
        </div></div>

        <!-- 5. å¯†ç ç”Ÿæˆ -->
	    <div id="panel-pwd" class="panel"><div class="card">
            <h2>â˜ï¸ ç†µå¢å¯†ç  (Cloud Secrets)</h2>
            <input type="range" id="pwd-len" min="8" max="64" value="16" oninput="document.getElementById('pv').innerText=this.value">
            <div style="margin-bottom: 10px;">é•¿åº¦: <span id="pv">16</span></div>
            <button onclick="runTask('password')">è®¡ç®—å¯†ç </button>
        </div></div>

        <!-- 6. ç‰©ç†ä»¿çœŸ -->
        <div id="panel-phy" class="panel"><div class="card">
            <h2>âš›ï¸ 2D æ³¢åŠ¨æ–¹ç¨‹æ•°å€¼æ±‚è§£ (FDM Solver)</h2>
            <p style="color:#666; font-size:13px;">äº‘ç«¯å°†æ„å»º 100x100 ç½‘æ ¼ï¼Œåˆ©ç”¨ Numpy æ±‚è§£åå¾®åˆ†æ–¹ç¨‹ï¼šâˆ‚Â²u/âˆ‚tÂ² = cÂ²âˆ‡Â²u</p>
            <label>å¹²æ‰°æºä½ç½® (X, Y):</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="phy-x" value="0.5" step="0.1" placeholder="X (0-1)">
                <input type="number" id="phy-y" value="0.5" step="0.1" placeholder="Y (0-1)">
            </div>
            <label>æ¼”åŒ–æ­¥æ•°: <span id="step-val">50</span></label>
            <input type="range" id="phy-steps" min="10" max="150" value="50" oninput="document.getElementById('step-val').innerText=this.value">
            <button onclick="runTask('phy_wave')">ğŸš€ å¯åŠ¨äº‘ç«¯ç‰©ç†å¼•æ“</button>
        </div></div>

        <!-- 7. AI å®¡è®¡ -->
        <div id="panel-audit" class="panel"><div class="card">
            <h2>ğŸ§  AI æ™ºèƒ½ä»£ç å®¡è®¡ </h2>
            <select id="audit-lang"><option>Python</option><option>Javascript</option><option>Java</option><option>C++</option></select>
            <div class="audit-container">
                <div class="code-editor">
                    <label>ğŸ“ æºä»£ç è¾“å…¥:</label>
                    <textarea id="audit-code" style="height:100%" placeholder="// è¯·åœ¨æ­¤å¤„ç²˜è´´éœ€è¦å®¡æŸ¥çš„ä»£ç ..."></textarea>
                </div>
                <div class="audit-result" id="audit-output">
                    <h3>ä»£ç å®¡è®¡æŠ¥å‘Š</h3>
                    <div style="color:#999; margin-top:20px;">ç­‰å¾…æäº¤...<br>AI æ¶æ„å¸ˆå°†ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œåˆ†æï¼š
                        <ul><li>é€»è¾‘æ¼æ´ä¸ Bug</li><li>æ€§èƒ½ç“¶é¢ˆä¼˜åŒ–</li><li>å®‰å…¨é£é™©æ£€æµ‹</li></ul>
                    </div>
                </div>
            </div>
            <button onclick="runTask('audit')" style="margin-top:10px">ğŸš€ æäº¤ç»™ AI æ¶æ„å¸ˆå®¡æŸ¥</button>
        </div></div>
	        <!-- 8. Base64 è½¬æ¢ (è¡¥å…¨) -->
        <div id="panel-base64" class="panel"><div class="card">
            <h2>ğŸ”£ Base64 è½¬æ¢</h2>
            <select id="b64-mode"><option value="encode">ç¼–ç </option><option value="decode">è§£ç </option></select>
            <textarea id="b64-text" rows="4" placeholder="è¾“å…¥å†…å®¹..."></textarea>
            <button onclick="runTask('base64')">è½¬æ¢</button>
        </div></div>

	<div id="panel-ua" class="panel"><div class="card">
            <h2>ğŸ“² è®¿å®¢è®¾å¤‡æŒ‡çº¹åˆ†æ</h2>
            <p style="color:#666; font-size:13px;">åç«¯è§£æ HTTP è¯·æ±‚å¤´ä¸­çš„ User-Agent å­—æ®µï¼Œè¯†åˆ«æ‚¨çš„æ“ä½œç³»ç»Ÿä¸ç¯å¢ƒã€‚</p>
            <button onclick="runTask('ua')">ï•µï¸â€â™‚ï¸ åˆ†ææˆ‘çš„è®¾å¤‡</button>
            <div id="ua-result-box" style="margin-top:20px; display:none;">
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:10px;">
                    <strong>æ“ä½œç³»ç»Ÿ:</strong> <span id="res-os" style="color:var(--primary)">-</span>
                </div>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; word-break:break-all;">
                    <strong>åŸå§‹ User-Agent:</strong><br>
                    <code id="res-raw" style="color:#666; font-size:12px;">-</code>
                </div>
            </div>
        </div></div>

        <!-- 8.6 ç½‘ç«™å¿ƒè·³æ£€æµ‹ (æ–°å¢) -->
        <div id="panel-site" class="panel"><div class="card">
            <h2>ğŸ’“ ç½‘ç«™å­˜æ´»ä¸å»¶è¿Ÿæ£€æµ‹</h2>
            <p style="color:#666; font-size:13px;">ç”±äº‘ç«¯èŠ‚ç‚¹å‘èµ·æ¢æµ‹ï¼ŒçœŸå®åæ˜ æœåŠ¡å™¨è¿é€šæ€§ã€‚</p>
            <input type="text" id="site-url" placeholder="è¾“å…¥ç½‘å€ï¼Œä¾‹å¦‚ www.baidu.com">
            <button onclick="runTask('check_site')">ğŸ’“ å¼€å§‹è¯Šæ–­</button>
            <div id="site-result-box" style="margin-top:20px; display:none;"></div>
        </div></div>


	<!-- 10. é˜…åå³ç„š (SecretNote) -->
        <div id="panel-burn" class="panel"><div class="card">
            <h2>ğŸ”¥ é˜…åå³ç„š (SecretNote)</h2>
            <p style="color:#666; font-size:13px;">ç”Ÿæˆçš„é“¾æ¥åªèƒ½è®¿é—®ä¸€æ¬¡ï¼Œè¯»å–åæœåŠ¡å™¨ç«¯æ•°æ®ç«‹å³æ°¸ä¹…é”€æ¯ã€‚</p>

            <label style="font-size:12px; color:#888;">è¾“å…¥ç§˜å¯†å†…å®¹ (ä¾‹å¦‚: helloworld):</label>
            <textarea id="burn-text" placeholder="åœ¨æ­¤è¾“å…¥ç§˜å¯†..."></textarea>
            <button onclick="runTask('save_note')">ç”Ÿæˆä¸€æ¬¡æ€§é“¾æ¥</button>

            <div id="burn-link-area" style="display:none; margin-top:15px; padding:15px; background:#f6ffed; border:1px solid #b7eb8f; border-radius:6px;">
                <strong style="color:#52c41a;">ç§˜å¯†é“¾æ¥å·²ç”Ÿæˆ:</strong>
                <div id="burn-res-id" style="font-family:monospace; font-weight:bold; margin:10px 0; padding:10px; background:#fff; border:1px dashed #ccc;"></div>
                <p style="font-size:12px; color:#666;">å°†æ­¤ ID å‘ç»™å¯¹æ–¹ï¼Œä¸€æ—¦æŸ¥çœ‹å°†ç«‹å³å¤±æ•ˆã€‚</p>
            </div>

            <hr style="margin:25px 0; border:0; border-top:1px dashed #eee;">

            <h3>æŸ¥çœ‹ç§˜å¯†</h3>
            <label style="font-size:12px; color:#888;">è¾“å…¥ç§˜å¯† ID (ä¾‹å¦‚: 8486ed0fe7):</label>
            <input type="text" id="burn-id" placeholder="åœ¨æ­¤è¾“å…¥ ID">
            <button onclick="runTask('read_note')" style="background:#ff4d4f">æŸ¥çœ‹å¹¶é”€æ¯</button>

            <div id="burn-read-result" style="display:none; margin-top:15px; padding:15px; background:#fff1f0; border:1px solid #ffccc7; border-radius:6px;">
                <strong style="color:#cf1322;">å†…å®¹å·²é”€æ¯ï¼Œæ— æ³•å†æ¬¡è®¿é—®:</strong>
                <pre id="burn-read-content" style="white-space:pre-wrap; margin-top:10px; font-weight:bold;"></pre>
            </div>
        </div></div>

	<!-- ä¸»åŒºåŸŸæ–°å¢é¢æ¿ -->
        <div id="panel-safeimg" class="panel"><div class="card">
            <h2>ğŸ›¡ï¸ å›¾ç‰‡å®‰å…¨è¯†åˆ«</h2>
            <div class="image-upload-area" onclick="document.getElementById('safe-file').click()">
            <div style="font-size:30px;">ğŸ“¸</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡è¿›è¡Œåˆè§„æ£€æµ‹</p>
            <input type="file" id="safe-file" style="display:none" onchange="handleSafeUpload(this)">
        </div>
        <div id="safe-preview-box" style="display:none; text-align:center;">
            <img id="safe-preview" style="max-width:100%; max-height:200px; border-radius:8px;">
            <button onclick="runTask('check_image')" style="margin-top:10px; width:100%;">ğŸ” å¼€å§‹å®‰å…¨æ‰«æ</button>
        </div>
        <div id="safe-result-box" style="display:none; margin-top:15px; padding:15px; background:#f8f9fa; border-radius:8px;"></div>
        </div></div>


        <!-- ç»“æœå±•ç¤ºé¢æ¿ (å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ JS ä¼šå´©æºƒ) -->
        <div class="card" id="result-card" style="display:none">
            <h2 style="font-size: 18px;">å¤„ç†ä¸­å¿ƒ</h2>
            <div id="md-result-area">
                <span style="font-size:12px; color:#888">ğŸ“„ è¯†åˆ«ç»“æœ <button class="copy-btn" onclick="copyText('final-result')">å¤åˆ¶</button></span>
                <div id="final-result" class="res-content"></div>
            </div>
            <div id="plain-result-area" style="display:none; margin-top:15px">
                <span style="font-size:12px; color:#888">ğŸ“ çº¯æ–‡æœ¬å¯¹é½ <button class="copy-btn" onclick="copyText('plain-result')">å¤åˆ¶</button></span>
                <div id="plain-result" class="res-content"></div>
            </div>
            <button id="btn-ai-trigger" class="btn-ai" onclick="runAiCleanup()">âœ¨ AI æ™ºèƒ½é‡æ’</button>
            <div id="ai-result-box" class="ai-box">
                <span style="font-size:12px; color:#764ba2">ğŸ§  AI é‡æ’ç»“æœ <button class="copy-btn" onclick="copyText('ai-result-content')">å¤åˆ¶</button></span>
                <div id="ai-result-content" class="res-content"></div>
            </div>
            <button id="btn-trans-trigger" class="btn-trans" onclick="runAiTranslate()">ğŸ® ä¸­å¤–æ–‡äº’è¯‘</button>
            <div id="trans-result-box" class="ai-box" style="border-color:#28a745">
                <span style="font-size:12px; color:#28a745">ğŸ® ç¿»è¯‘ç»“æœ <button class="copy-btn" onclick="copyText('trans-result-content')">å¤åˆ¶</button></span>
                <div id="trans-result-content" class="res-content"></div>
            </div>
        </div>

        <!-- ç»ˆç«¯çª—å£ (å¿…é¡»å­˜åœ¨) -->
        <div class="terminal-window" id="terminal"><div>[System] åˆå§‹åŒ–å®Œæˆ...</div></div>
    </div> <!-- ç»“æŸ main -->

<script>
    const API_URL = "https://main-handler-toolbox-service-wfobwllmcq.cn-beijing.fcapp.run";
    let currentImageBase64 = "";
    let activeTabId = 'dedup';



    window.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (e) => {
                    // æ ¹æ®å½“å‰é¢æ¿å†³å®šé¢„è§ˆä½ç½®
                    let previewId = '';
                    if (activeTabId === 'ocr') previewId = 'img-preview';
                    else if (activeTabId === 'table') previewId = 'img-table-preview';
                    else if (activeTabId === 'safeimg') {
                        previewId = 'safe-preview';
                        document.getElementById('safe-preview-box').style.display = 'block';
                    }

                    if (previewId) {
                        const img = document.getElementById(previewId);
                        img.src = e.target.result; 
                        img.style.display = 'block';
                        currentImageBase64 = e.target.result.split(',')[1];
                        log('INFO', 'å·²ä»å‰ªè´´æ¿è¯»å–å›¾ç‰‡');
                    }
                };
                reader.readAsDataURL(blob);
            }
        }
    });


    function switchTab(id) {
        activeTabId = id;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('panel-' + id).classList.add('active');
        
        // 1. éšè—æ‰€æœ‰ç»“æœé¢æ¿ã€AI å¢å¼ºæ¡†ã€ä»¥åŠç‰¹å®šå·¥å…·çš„åé¦ˆåŒºåŸŸ
        document.getElementById('result-card').style.display = 'none';
        document.getElementById('plain-result-area').style.display = 'none'; 
        document.querySelectorAll('.ai-box, .btn-ai, .btn-trans, #safe-result-box, #site-result-box, #burn-link-area, #burn-read-result').forEach(el => el.style.display = 'none');
        
        // 2. æ¸…ç©ºç»“æœæ–‡æœ¬
        document.getElementById('final-result').innerText = "";
        document.getElementById('plain-result').innerText = "";
        
        // 3. æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ•°æ®
        document.querySelectorAll('textarea').forEach(t => t.value = "");
        document.querySelectorAll('input').forEach(i => {
            if (i.type === 'text' || i.type === 'file') i.value = "";
        });
        
        // 4. é‡ç½®æ‰€æœ‰å›¾ç‰‡é¢„è§ˆå’Œ Base64 ç¼“å­˜
        currentImageBase64 = "";
        document.querySelectorAll('img[id$="preview"]').forEach(img => {
            img.src = "";
            img.style.display = 'none';
        });
        document.getElementById('safe-preview-box').style.display = 'none';

        // 5. é‡ç½® AI å®¡è®¡æŠ¥å‘Š
        const auditOut = document.getElementById('audit-output');
        if(auditOut) auditOut.innerHTML = `<h3>ä»£ç å®¡è®¡æŠ¥å‘Š</h3><div style="color:#999; margin-top:20px;">ç­‰å¾…æäº¤...</div>`;
        
        log('INFO', 'åˆ‡æ¢è‡³ ' + id + ' é¢æ¿å¹¶é‡ç½®çŠ¶æ€');
    }


    function handleFileInput(input, previewId) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById(previewId).src = e.target.result;
            document.getElementById(previewId).style.display = 'block';
            currentImageBase64 = e.target.result.split(',')[1];
        };
        reader.readAsDataURL(file);
    }

    function log(type, msg) {
        const t = document.getElementById('terminal');
        t.innerHTML += `<div>[${type}] ${msg}</div>`;
        t.scrollTop = t.scrollHeight;
    }

    // æ›¿æ¢åŸæœ¬çš„ handleSafeUpload å‡½æ•°
    function handleSafeUpload(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('safe-preview');
            preview.src = e.target.result;
            preview.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡
            document.getElementById('safe-preview-box').style.display = 'block'; // æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
            currentImageBase64 = e.target.result.split(',')[1];
            log('INFO', 'å®‰å…¨è¯†åˆ«å›¾ç‰‡å·²è½½å…¥');
        };
        reader.readAsDataURL(input.files[0]);
    }



    async function runTask(type) {
        log('TASK', 'å¯åŠ¨ ' + type);
        
        // --- 0. æ¸…é™¤ä¸Šä¸€æ¬¡ä»»åŠ¡çš„æ®‹ç•™ UI (AI å¢å¼ºæŒ‰é’®ä¸ç»“æœæ¡†) ---
        document.querySelectorAll('.btn-ai, .btn-trans, .ai-box').forEach(el => el.style.display = 'none');
        
        let payload = { action: type };
        
        // --- 1. è¾“å…¥å‚æ•°è·å–é€»è¾‘ ---
        if(type === 'dedup') payload.content = document.getElementById('inp-dedup').value;
        else if(type === 'ocr' || type === 'table_ocr') payload.image = currentImageBase64;
        else if(type === 'qr') payload.text = document.getElementById('inp-qr').value;
        else if(type === 'password') payload.length = document.getElementById('pwd-len').value;
        else if(type === 'phy_wave') { 
            payload.cx = document.getElementById('phy-x').value; 
            payload.cy = document.getElementById('phy-y').value;
            payload.steps = document.getElementById('phy-steps').value;
        }
        else if(type === 'audit') { 
            payload.code = document.getElementById('audit-code').value; 
            payload.lang = document.getElementById('audit-lang').value;
            document.getElementById('audit-output').innerText = "â³ AI æ­£åœ¨å®¡è®¡...";
        }
        else if(type === 'base64') {
            payload.mode = document.getElementById('b64-mode').value;
            payload.text = document.getElementById('b64-text').value;
        }
        else if(type === 'check_site') {
            payload.url = document.getElementById('site-url').value;
        }
        else if(type === 'save_note') payload.text = document.getElementById('burn-text').value;
        else if(type === 'read_note') payload.id = document.getElementById('burn-id').value;
        else if(type === 'check_image' ) {
            payload.image = currentImageBase64;
        }

        // --- 2. ç•Œé¢é¢„å¤„ç† ---
        // éå®¡è®¡/è®¾å¤‡åˆ†æ/ç½‘ç«™æ£€æµ‹ä»»åŠ¡æ˜¾ç¤ºé€šç”¨ç»“æœé¢æ¿
        if(type !== 'audit' && type !== 'ua' && type !== 'check_site') {
            document.getElementById('result-card').style.display = 'block';
            document.getElementById('final-result').innerText = "â³ æ­£åœ¨å¤„ç†ä¸­...";
            document.getElementById('plain-result-area').style.display = 'none';
        }

        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) 
            });
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);

            // --- 3. ç»“æœæ¸²æŸ“é€»è¾‘ ---
            if(type === 'audit') {
                document.getElementById('audit-output').innerHTML = marked.parse(data.data);
            } 
            else if(type === 'ua') {
                document.getElementById('ua-result-box').style.display = 'block';
                document.getElementById('res-os').innerText = data.os_guess;
                document.getElementById('res-raw').innerText = data.user_agent;
            } 
            else if(type === 'check_site') {
                const resDiv = document.getElementById('site-result-box');
                resDiv.style.display = 'block';
                const isUp = data.status === 'UP';
                const color = isUp ? '#e6fffa' : '#fff5f5';
                const textColor = isUp ? '#2c7a7b' : '#c53030';
                resDiv.innerHTML = `
                    <div style="background:${color}; color:${textColor}; padding:20px; border-radius:8px; border:1px solid ${textColor}40;">
                        <h3 style="margin:0 0 10px 0;">${isUp ? 'âœ…' : 'âŒ'} ${data.status}</h3>
                        <div style="font-size:13px;"><strong>ç›®æ ‡:</strong> ${data.url}</div>
                        <div style="font-size:13px;"><strong>çŠ¶æ€ç :</strong> ${data.code}</div>
                        <div style="font-size:13px;"><strong>å»¶è¿Ÿ:</strong> ${data.latency_ms || '-'} ms</div>
                        ${data.error ? `<div style="margin-top:10px; font-size:11px; opacity:0.8;">åŸå› : ${data.error}</div>` : ''}
                    </div>`;
            }

            else if(type === 'check_image') {
                const box = document.getElementById('safe-result-box'); 
                box.style.display = 'block';
                const levelClass = data.risk_level === 'å®‰å…¨' ? 'risk-safe' : 'risk-high';
                box.innerHTML = `
                    <h3 style="margin:0 0 10px 0; font-size:16px;">ğŸ›¡ï¸ å®‰å…¨æ£€æµ‹æŠ¥å‘Š</h3>
                    <div style="margin-bottom:8px;"><strong>é£é™©ç­‰çº§ï¼š</strong> <span class="risk-level ${levelClass}">${data.risk_level}</span></div>
                    <div style="margin-bottom:8px;"><strong>ç½®ä¿¡åº¦ï¼š</strong> ${data.confidence}%</div>
                    <div style="margin-bottom:8px;"><strong>æ£€æµ‹æ ‡ç­¾ï¼š</strong> ${data.tags.map(t => `<span style="background:#eee; padding:2px 6px; border-radius:4px; margin-right:5px; font-size:11px;">${t}</span>`).join('')}</div>
                    <div style="font-size:12px; color:#666; border-top:1px solid #eee; padding-top:8px; margin-top:8px;">${data.message}</div>
                `;
                document.getElementById('final-result').innerText = "æ£€æµ‹å®Œæˆï¼Œç»“æœå·²åœ¨ä¸Šæ–¹é¢æ¿æ›´æ–°ã€‚";
            }
            else if(type === 'save_note') {
                document.getElementById('burn-link-area').style.display = 'block';
                document.getElementById('burn-res-id').innerText = data.note_id;
                document.getElementById('final-result').innerText = "ç§˜å¯†å·²åŠ å¯†å­˜å‚¨ï¼ŒID å·²åœ¨ä¸Šæ–¹ç”Ÿæˆã€‚";
            }
            else if(type === 'read_note') {
                document.getElementById('burn-read-result').style.display = 'block';
                document.getElementById('burn-read-content').innerText = data.content;
                document.getElementById('final-result').innerText = "å†…å®¹å·²è¯»å–å¹¶ä»æœåŠ¡å™¨é”€æ¯ã€‚";
            }
            else {

                const resBox = document.getElementById('final-result');
                // é€‚é…ï¼šåç«¯è¿”å› result (æ ‡å‡†) æˆ– result_image
                const displayImage = data.result || data.result_image;
                
                if(data.type === 'image' || data.result_image) {
                    // å¦‚æœä¸æ˜¯ä»¥ data: å¼€å¤´ï¼Œè¡¥å…¨ base64 å‰ç¼€
                    const src = displayImage.startsWith('data:') ? displayImage : 'data:image/png;base64,' + displayImage;
                    resBox.innerHTML = `<img src="${src}" style="max-width:100%; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">`;
                    if(data.message) log('INFO', data.message); 
                } else {
                    resBox.innerText = data.result || data.content || data.note_id || "æ“ä½œå®Œæˆ";
                    if(type === 'table_ocr' && data.plain_text) {
                        document.getElementById('plain-result-area').style.display = 'block';
                        document.getElementById('plain-result').innerText = data.plain_text;
                    }
                    if(type === 'ocr') document.getElementById('btn-ai-trigger').style.display = 'block';
                }
            }
            log('SUCCESS', 'ä»»åŠ¡å®Œæˆ');
        } catch(e) { 
            log('ERR', e.message); 
            if(type === 'audit') document.getElementById('audit-output').innerText = "âŒ å¤„ç†å¤±è´¥: " + e.message;
        }
    }


    async function runAiCleanup() {
        const btn = document.getElementById('btn-ai-trigger');
        btn.innerText = "ğŸ§  å¤„ç†ä¸­...";
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'ai_clean', content: document.getElementById('final-result').innerText }) 
            });
            const data = await res.json();
            document.getElementById('ai-result-box').style.display = 'block';
            document.getElementById('ai-result-content').innerText = data.result;
            document.getElementById('btn-trans-trigger').style.display = 'block';
        } finally { btn.innerText = "âœ¨ AI æ™ºèƒ½é‡æ’"; }
    }

    async function runAiTranslate() {
        const btn = document.getElementById('btn-trans-trigger');
        btn.innerText = "ğŸ® ç¿»è¯‘ä¸­...";
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'ai_translate', content: document.getElementById('ai-result-content').innerText }) 
            });
            const data = await res.json();
            document.getElementById('trans-result-box').style.display = 'block';
            document.getElementById('trans-result-content').innerText = data.result;
        } finally { btn.innerText = "ğŸ® ä¸­å¤–æ–‡äº’è¯‘"; }
    }

    async function copyText(id) {
        const text = document.getElementById(id).innerText;
        await navigator.clipboard.writeText(text);
        alert("å·²å¤åˆ¶");
    }
</script>
</body>
</html>
