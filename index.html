<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Cloud Console</title>
    <style>
        :root { 
            --primary: #007AFF; 
            --bg: #F0F2F5; 
            --terminal-bg: #1E1E1E; 
            --terminal-text: #00FF00; 
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            --trans-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 240px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 20px; z-index: 10; }
        .logo { font-size: 18px; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; background: #28a745; border-radius: 50%; box-shadow: 0 0 5px #28a745; }
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; color: #666; transition: 0.2s; }
        .nav-item.active { background: #E3F2FD; color: var(--primary); font-weight: bold; }
        .main { flex: 1; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        textarea, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin: 10px 0; font-family: monospace; }
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .terminal-window { background: var(--terminal-bg); border-radius: 8px; padding: 15px; color: var(--terminal-text); font-family: monospace; font-size: 12px; height: 150px; overflow-y: auto; }
        
        .copy-btn { float: right; padding: 4px 10px; font-size: 11px; background: #f0f0f0; color: #555; border-radius: 4px; margin-top: -4px; }
        .copy-btn:hover { background: #e0e0e0; color: var(--primary); }
        .result-label { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 8px; display: block; }
        .res-content { padding:15px; border-radius:6px; white-space:pre-wrap; font-family: "SF Mono", "Monaco", "Inconsolata", monospace !important; font-size: 13px; border: 1px solid #eee; overflow-x: auto; }
        .ai-box { border: 1px solid #764ba2; background: #fdfaff !important; display: none; margin-top: 15px; animation: fadeIn 0.5s; }
        .btn-ai { background: var(--ai-gradient); margin-top: 15px; width: 100%; display: none; }
        .trans-box { border: 1px solid #28a745; background: #f6fff8 !important; display: none; margin-top: 15px; animation: fadeIn 0.5s; }
        .btn-trans { background: var(--trans-gradient); margin-top: 10px; width: 100%; display: none; }
        
        /* ğŸš€ ç²˜è´´æç¤ºæ ·å¼ */
        .paste-hint { font-size: 12px; color: #999; margin-bottom: 8px; display: block; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(5px);} to { opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><div class="status-dot"></div> äº‘ä¸Šå·¥å…·ç®±</div>
        <div class="nav-item active" onclick="switchTab('dedup')">âš¡ æ–‡æœ¬æ™ºèƒ½å»é‡</div>
        <div class="nav-item" onclick="switchTab('ocr')">ğŸ‘ï¸ å›¾ç‰‡æ–‡æœ¬è¯†åˆ«</div>
        <div class="nav-item" onclick="switchTab('table')">ğŸ“Š å›¾ç‰‡è¡¨æ ¼æ–‡æœ¬è¯†åˆ«</div>
    </div>

    <div class="main">
        <!-- æ–‡æœ¬å»é‡ -->
        <div id="panel-dedup" class="panel active">
            <div class="card">
                <h2>â˜ï¸ æ–‡æœ¬å»é‡ (Deduplication)</h2>
                <textarea id="inp-dedup" rows="6" placeholder="è¾“å…¥é‡å¤åˆ—è¡¨..."></textarea>
                <button onclick="runCloudTask('dedup')">æ‰§è¡Œäº‘ç«¯è®¡ç®—</button>
            </div>
        </div>

        <!-- å›¾åƒè¯†åˆ« -->
        <div id="panel-ocr" class="panel">
            <div class="card">
                <h2>â˜ï¸ å›¾ç‰‡æ–‡æœ¬è¯†åˆ«</h2>
                <span class="paste-hint">æç¤ºï¼šæ”¯æŒç‚¹å‡»ä¸Šä¼ æˆ–ç›´æ¥ <b>Ctrl + V</b> ç²˜è´´æˆªå›¾</span>
                <input type="file" id="inp-ocr-file" accept="image/*" onchange="handleFileInput(this, 'img-preview')">
                <div style="text-align: center;"><img id="img-preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border: 1px solid #eee; border-radius: 4px;"></div>
                <br><button onclick="runCloudTask('ocr')">å¼€å§‹è¯†åˆ«æ–‡å­—</button>
            </div>
        </div>

        <!-- è¡¨æ ¼è¯†åˆ« -->
        <div id="panel-table" class="panel">
            <div class="card">
                <h2>ğŸ“Š å›¾ç‰‡è¡¨æ ¼æ–‡æœ¬è¯†åˆ«</h2>
                <p style="color:#666; font-size:13px">è¯†åˆ«å›¾ç‰‡ä¸­çš„è¡¨æ ¼å¹¶è¿˜åŸè¡Œåˆ—ç»“æ„ï¼ˆMarkdown/çº¯æ–‡æœ¬åŒç‰ˆæœ¬ï¼‰ã€‚</p>
                <span class="paste-hint">æç¤ºï¼šæ”¯æŒç‚¹å‡»ä¸Šä¼ æˆ–ç›´æ¥ <b>Ctrl + V</b> ç²˜è´´è¡¨æ ¼æˆªå›¾</span>
                <input type="file" id="inp-table-file" accept="image/*" onchange="handleFileInput(this, 'img-table-preview')">
                <div style="text-align: center;"><img id="img-table-preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border: 1px solid #eee; border-radius: 4px;"></div>
                <br><button onclick="runCloudTask('table')">å¼€å§‹æå–è¡¨æ ¼</button>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="card" id="result-card" style="display:none">
            <div style="border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px;">
                <h2 style="margin:0; font-size: 18px;">å¤„ç†ä¸­å¿ƒ (Processing Hub)</h2>
            </div>
            
            <div id="md-result-area" style="margin-bottom: 15px;">
                <span class="result-label" id="main-result-label">ğŸ“„ è¯†åˆ«ç»“æœ (Markdown) <button class="copy-btn" onclick="copyToClipboard('final-result', this)">ğŸ“‹ å¤åˆ¶</button></span>
                <div id="final-result" class="res-content" style="background:#f9f9f9;"></div>
            </div>

            <div id="plain-result-area" style="margin-bottom: 15px; display: none;">
                <span class="result-label">ğŸ“ çº¯æ–‡æœ¬å¯¹é½ç‰ˆ <button class="copy-btn" onclick="copyToClipboard('plain-result', this)">ğŸ“‹ å¤åˆ¶</button></span>
                <div id="plain-result" class="res-content" style="background:#fff; border: 1px dashed #ccc; color: #444;"></div>
            </div>

            <button id="btn-ai-trigger" class="btn-ai" onclick="runAiCleanup()">âœ¨ AI æ™ºèƒ½é‡æ’</button>
            <div id="ai-result-box" class="ai-box" style="padding:15px; border-radius:6px;">
                <span class="result-label" style="color:#764ba2">ğŸ§  AI æ™ºèƒ½é‡æ’ç»“æœ <button class="copy-btn" onclick="copyToClipboard('ai-result-content', this)">ğŸ“‹ å¤åˆ¶</button></span>
                <div id="ai-result-content" class="res-content" style="color: #333; border: none; padding: 0;"></div>
            </div>

            <button id="btn-trans-trigger" class="btn-trans" onclick="runAiTranslate()">ğŸ® ä¸­å¤–æ–‡äº’è¯‘</button>
            <div id="trans-result-box" class="trans-box" style="padding:15px; border-radius:6px;">
                <span class="result-label" style="color:#28a745">ğŸ® ç¿»è¯‘ç»“æœ <button class="copy-btn" onclick="copyToClipboard('trans-result-content', this)">ğŸ“‹ å¤åˆ¶</button></span>
                <div id="trans-result-content" class="res-content" style="color: #333; border: none; padding: 0;"></div>
            </div>
        </div>

        <div class="terminal-window" id="terminal"><div>[System] æ§åˆ¶å°å°±ç»ª...</div></div>
    </div>

<script>
    const API_URL = "https://main-handler-toolbox-service-wfobwllmcq.cn-beijing.fcapp.run";
    let currentImageBase64 = "";
    let activeTabId = 'dedup'; // ğŸš€ è®°å½•å½“å‰æ´»åŠ¨æ ‡ç­¾

    function switchTab(id) {
        activeTabId = id;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('panel-' + id).classList.add('active');
        document.getElementById('result-card').style.display = 'none';
        currentImageBase64 = ""; // åˆ‡æ¢æ—¶æ¸…ç©ºç¼“å­˜
    }

    function log(type, msg) {
        const term = document.getElementById('terminal');
        term.innerHTML += `<div><span style="color:#888">[${new Date().toLocaleTimeString()}]</span> <span style="color:#4facfe">[${type}]</span> ${msg}</div>`;
        term.scrollTop = term.scrollHeight;
    }

    async function copyToClipboard(elementId, btn) {
        const text = document.getElementById(elementId).innerText;
        if (!text || text.startsWith("â³")) return;
        try {
            await navigator.clipboard.writeText(text);
            const old = btn.innerHTML; btn.innerHTML = "âœ… å·²å¤åˆ¶"; btn.style.color = "#28a745";
            setTimeout(() => { btn.innerHTML = old; btn.style.color = "#555"; }, 2000);
            log('SYSTEM', 'æ–‡æœ¬å·²å¤åˆ¶');
        } catch (err) { log('ERROR', 'å¤åˆ¶å¤±è´¥'); }
    }

    // ğŸš€ ç»Ÿä¸€å›¾ç‰‡å¤„ç†é€»è¾‘
    function processImageFile(file, previewId) {
        if (!file || !file.type.match('image.*')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.getElementById(previewId);
            img.src = e.target.result;
            img.style.display = 'block';
            currentImageBase64 = e.target.result.split(',')[1];
            log('LOCAL', 'å›¾ç‰‡è¯»å–æˆåŠŸï¼ˆæ¥è‡ª' + (file.fromPaste ? 'ç²˜è´´' : 'ä¸Šä¼ ') + 'ï¼‰');
        };
        reader.readAsDataURL(file);
    }

    // æ–‡ä»¶é€‰æ‹©æ¡†è§¦å‘
    function handleFileInput(input, previewId) {
        processImageFile(input.files[0], previewId);
    }

    // ğŸš€ ç›‘å¬ç²˜è´´äº‹ä»¶
    window.addEventListener('paste', (e) => {
        // åªæœ‰åœ¨ OCR æˆ– Table é¡µé¢æ‰å“åº”ç²˜è´´
        if (activeTabId !== 'ocr' && activeTabId !== 'table') return;

        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                blob.fromPaste = true;
                const targetPreviewId = (activeTabId === 'ocr') ? 'img-preview' : 'img-table-preview';
                processImageFile(blob, targetPreviewId);
                break;
            }
        }
    });

    async function runCloudTask(type) {
        let payload = { action: type };
        if(type === 'dedup') payload.content = document.getElementById('inp-dedup').value;
        else if(type === 'ocr' || type === 'table') {
            if(!currentImageBase64) return alert("è¯·å…ˆä¸Šä¼ æˆ–æŒ‰ Ctrl+V ç²˜è´´å›¾ç‰‡");
            payload.image = currentImageBase64;
            if(type === 'table') payload.action = 'table_ocr';
        }

        document.getElementById('result-card').style.display = 'block';
        document.getElementById('plain-result-area').style.display = 'none';
        document.getElementById('ai-result-box').style.display = 'none';
        document.getElementById('trans-result-box').style.display = 'none';
        document.getElementById('btn-ai-trigger').style.display = 'none';
        document.getElementById('btn-trans-trigger').style.display = 'none';
        document.getElementById('final-result').innerText = "â³ æ­£åœ¨å¤„ç†ä¸­...";
        
        document.getElementById('main-result-label').firstChild.textContent = (type === 'table') ? "ğŸ“Š è¯†åˆ«ç»“æœ (Markdown) " : "ğŸ“„ åŸå§‹è¯†åˆ«ç»“æœ ";

        try {
            const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            document.getElementById('final-result').innerText = data.result || data.error;
            
            if(type === 'table' && data.plain_text) {
                document.getElementById('plain-result-area').style.display = 'block';
                document.getElementById('plain-result').innerText = data.plain_text;
                log('AI', 'è¡¨æ ¼å·²é€šè¿‡ DeepSeek V3.2 é€»è¾‘æ¸…æ´—å¹¶å¯¹é½');
            } else {
                log('SUCCESS', type + ' æ‰§è¡ŒæˆåŠŸ');
            }

            if(type === 'ocr') document.getElementById('btn-ai-trigger').style.display = 'block';
        } catch (e) { log('ERROR', 'è¯·æ±‚å¤±è´¥'); }
    }

    async function runAiCleanup() {
        const btn = document.getElementById('btn-ai-trigger');
        btn.disabled = true; btn.innerText = "ğŸ§  æ­£åœ¨é‡æ’...";
        document.getElementById('ai-result-box').style.display = 'block';
        document.getElementById('ai-result-content').innerText = "â³ æ­£åœ¨åˆ†æ...";
        try {
            const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'ai_clean', content: document.getElementById('final-result').innerText }) });
            const data = await res.json();
            document.getElementById('ai-result-content').innerText = data.result || data.error;
            document.getElementById('btn-trans-trigger').style.display = 'block';
            log('AI', 'æ™ºèƒ½é‡æ’å®Œæˆ');
        } catch (e) { log('ERROR', 'AIé‡æ’å¤±è´¥'); }
        finally { btn.disabled = false; btn.innerText = "âœ¨ AI æ™ºèƒ½é‡æ’"; }
    }

    async function runAiTranslate() {
        const btn = document.getElementById('btn-trans-trigger');
        btn.disabled = true; btn.innerText = "ğŸ® æ­£åœ¨ç¿»è¯‘...";
        document.getElementById('trans-result-box').style.display = 'block';
        document.getElementById('trans-result-content').innerText = "â³ æ­£åœ¨ç¿»è¯‘...";
        try {
            const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'ai_translate', content: document.getElementById('ai-result-content').innerText }) });
            const data = await res.json();
            document.getElementById('trans-result-content').innerText = data.result || data.error;
            log('AI', 'ç¿»è¯‘å®Œæˆ');
        } catch (e) { log('ERROR', 'ç¿»è¯‘å¤±è´¥'); }
        finally { btn.disabled = false; btn.innerText = "ğŸ® ç¿»è¯‘æˆä¸­æ–‡"; }
    }
</script>
</body>
</html>
